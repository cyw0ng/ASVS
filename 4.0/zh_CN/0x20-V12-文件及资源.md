# V12: 文件及资源验证需求

## 控制目标

确保一个被验证的应用满足如下的宏观需求：

* 不信任的文件数据应被针对性的以安全的方式处理。
* 来源于不信任源头的不信任文件数据，被储存于 web 根以外并设定为有限的权限。

## V12.1 文件上传需求

尽管 zip 炸弹的可测试性已被渗透测试手段充分覆盖，他们被定义为 L2 及更高的层次以鼓励在设计及开发过程中采用谨慎的手动测试，以避免自动化测试或技能不达标的手动渗透测试遗漏了可能的绝句服务攻击条件。

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.1.1** | 验证应用不会接受可能占满其存储空间或造成拒绝服务攻击的大文件。 | ✓ | ✓ | ✓ | 400 |
| **12.1.2** | 验证压缩文件使用前已被实施面向 zip 炸弹（可被解压后生成巨大文件以占满存储空间的小输入文件）的检查。 | | ✓ | ✓ | 409 |
| **12.1.3** | 验证文件体积配额及用户的最大文件数量已被使能，以保证单用户不能通过大量文件或连续的大文件占满存储。 | | ✓ | ✓ | 770 |

## V12.2 文件完整性需求

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.2.1** | 验证于非可信来源获取的文件在使用前被通过文件的具体内容实施了验证。 | | ✓ | ✓ | 434 |

## V12.3 文件执行需求

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.3.1** | Verify that user-submitted filename metadata is not used directly by system or framework filesystems and that a URL API is used to protect against path traversal. | ✓ | ✓ | ✓ | 22 |
| **12.3.2** | Verify that user-submitted filename metadata is validated or ignored to prevent the disclosure, creation, updating or removal of local files (LFI). | ✓ | ✓ | ✓ | 73 |
| **12.3.3** | Verify that user-submitted filename metadata is validated or ignored to prevent the disclosure or execution of remote files via Remote File Inclusion (RFI) or Server-side Request Forgery (SSRF) attacks.  | ✓ | ✓ | ✓ | 98 |
| **12.3.4** | Verify that the application protects against Reflective File Download (RFD) by validating or ignoring user-submitted filenames in a JSON, JSONP, or URL parameter, the response Content-Type header should be set to text/plain, and the Content-Disposition header should have a fixed filename. | ✓ | ✓ | ✓ | 641 |
| **12.3.5** | Verify that untrusted file metadata is not used directly with system API or libraries, to protect against OS command injection. | ✓ | ✓ | ✓ | 78 |
| **12.3.6** | Verify that the application does not include and execute functionality from untrusted sources, such as unverified content distribution networks, JavaScript libraries, node npm libraries, or server-side DLLs. |  | ✓ | ✓ | 829 |

## V12.4 文件存储需求

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.4.1** | Verify that files obtained from untrusted sources are stored outside the web root, with limited permissions, preferably with strong validation. | ✓ | ✓ | ✓ | 922 |
| **12.4.2** | Verify that files obtained from untrusted sources are scanned by antivirus scanners to prevent upload of known malicious content. | ✓ | ✓ | ✓ | 509 |

## V12.5 文件下载需求

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.5.1** | Verify that the web tier is configured to serve only files with specific file extensions to prevent unintentional information and source code leakage. For example, backup files (e.g. .bak), temporary working files (e.g. .swp), compressed files (.zip, .tar.gz, etc) and other extensions commonly used by editors should be blocked unless required. | ✓ | ✓ | ✓ | 552 |
| **12.5.2** | Verify that direct requests to uploaded files will never be executed as HTML/JavaScript content. | ✓ | ✓ | ✓ | 434 |

## V12.6 SSRF 保护需求

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.6.1** | Verify that the web or application server is configured with an allow list of resources or systems to which the server can send requests or load data/files from. | ✓ | ✓ | ✓ | 918 |

## 参考文献

更多的本领域相关内容，请参阅：

* [File Extension Handling for Sensitive Information](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload)
* [Reflective file download by Oren Hafif](https://www.trustwave.com/Resources/SpiderLabs-Blog/Reflected-File-Download---A-New-Web-Attack-Vector/)
* [OWASP Third Party JavaScript Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Third_Party_Javascript_Management_Cheat_Sheet.html)
